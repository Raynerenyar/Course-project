FROM maven:3.8.3-openjdk-17 AS build

WORKDIR /app

# FIRST STAGE
COPY src /app/src
COPY pom.xml /app
ENV $(cat .env | xargs)
# RUN --mount=type=secret,id=my_env source /run/secrets/my_env \
#    && mvn -f /app/pom.xml clean package
RUN mvn -f /app/pom.xml clean package -Dmaven.test.skip

# SECOND STAGE
FROM openjdk:17-oracle

# ENV $(cat .env | xargs)
ARG MYSQLUSER
ENV MYSQLUSER $MYSQLUSER
ARG MYSQLPASSWORD
ENV MYSQLPASSWORD $MYSQLPASSWORD
ARG MYSQLDATABASE
ENV MYSQLDATABASE $MYSQLDATABASE


ARG MYSQLUSER
ENV MYSQLUSER=$MYSQLUSER
ARG MYSQLPASSWORD
ENV MYSQLPASSWORD=$MYSQLPASSWORD
ARG MYSQLDATABASE
ENV MYSQLDATABASE=$MYSQLDATABASE
ARG MYSQLHOST
ENV MYSQLHOST=$MYSQLHOST
ARG MYSQLPORT
ENV MYSQLPORT=$MYSQLPORT
ARG MYSQL_URL
ENV MYSQL_URL=jdbc:mysql://${MYSQLHOST}:${MYSQLPORT}/${MYSQLDATABASE}
# jdbc:mysql://${MYSQLHOST}:${MYSQLPORT}/${MYSQLDATABASE}

ARG CLIENT_URL
ENV CLIENT_URL=$CLIENT_URL
ARG DEV_CLIENT_URL
ENV DEV_CLIENT_URL=$DEV_CLIENT_URL

ARG ETH_WALLET_PUBLIC_ADDRESS
ENV ETH_WALLET_PUBLIC_ADDRESS=$ETH_WALLET_PUBLIC_ADDRESS
ARG ETH_WALLET_PRIVATE_KEY
ENV ETH_WALLET_PRIVATE_KEY=$ETH_WALLET_PRIVATE_KEY

ARG CROWDFUNDING_FACTORY_CONTRACT_ADDRESS
ENV CROWDFUNDING_FACTORY_CONTRACT_ADDRESS=$CROWDFUNDING_FACTORY_CONTRACT_ADDRESS
ARG FAUCET_CONTRACT_ADDRESS
ENV FAUCET_CONTRACT_ADDRESS=$FAUCET_CONTRACT_ADDRESS
ARG RPC0
ENV RPC0=$RPC0
ARG RPC1
ENV RPC1=$RPC1
ARG RPC2
ENV RPC2=$RPC2
ARG CHAIN_ID
ENV CHAIN_ID=$CHAIN_ID
ARG SEPOLIA_USDC_ADDRESS
ENV SEPOLIA_USDC_ADDRESS=$SEPOLIA_USDC_ADDRESS

ARG ETHERSCAN_API_KEY
ENV ETHERSCAN_API_KEY=$ETHERSCAN_API_KEY

ARG GANACHE_PUBLIC_ADDRESS
ENV GANACHE_PUBLIC_ADDRESS=$GANACHE_PUBLIC_ADDRESS
ARG GANACHE_PRIVATE_KEY
ENV GANACHE_PRIVATE_KEY=$GANACHE_PRIVATE_KEY
ARG DEV_RPC
ENV DEV_RPC=$DEV_RPC
ARG DEV_CHAIN_ID
ENV DEV_CHAIN_ID=$DEV_CHAIN_ID
ARG DEV_CROWDFUNDING_FACTORY_CONTRACT_ADDRESS
ENV DEV_CROWDFUNDING_FACTORY_CONTRACT_ADDRESS=$DEV_CROWDFUNDING_FACTORY_CONTRACT_ADDRESS
ARG DEV_FAUCET_CONTRACT_ADDRESS
ENV DEV_FAUCET_CONTRACT_ADDRESS=$DEV_FAUCET_CONTRACT_ADDRESS

ARG MONGOHOST
ENV MONGOHOST=$MONGOHOST
ARG MONGOPORT
ENV MONGOPORT=$MONGOPORT
ARG MONGOUSER
ENV MONGOUSER=$$MONGOUSER
ARG MONGOPASSWORD
ENV MONGOPASSWORD=$MONGOPASSWORD
ARG MONGODB
ENV MONGODB=$MONGODB
ARG MONGO_URL
ENV MONGO_URL=$MONGO_URL

ARG DA_APP_JWT_SECRET
ENV DA_APP_JWT_SECRET=$DA_APP_JWT_SECRET
ARG DA_APP_JWT_EXPIRATION
ENV DA_APP_JWT_EXPIRATION=$DA_APP_JWT_EXPIRATION
ARG DA_APP_JWT_COOKIENAME
ENV DA_APP_JWT_COOKIENAME=$DA_APP_JWT_COOKIENAME

COPY --from=build /app/target/assessment-0.0.1-SNAPSHOT.jar /app/target/assessment-0.0.1-SNAPSHOT.jar
# COPY /target/assessment-0.0.1-SNAPSHOT.jar /app/target/assessment-0.0.1-SNAPSHOT.jar

EXPOSE 6749

ENTRYPOINT ["java", "-jar", "/app/target/assessment-0.0.1-SNAPSHOT.jar"]